<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verse Vault</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Verse Vault: Your personal Bible memory app. Save, organize, and recall your favorite KJV Bible verses. Log in or use local storage.">
    <meta name="keywords" content="Bible, memory, verses, KJV, King James Version, scripture, app, online, personal, spiritual, learning, memorization, church, study">
    <meta name="author" content="Verse Vault App">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://verse-vault.github.io/verse-vault/"> <!-- Replace with your actual deployed URL -->


    <!-- Structured Data (JSON-LD) for Search Engines -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "Verse Vault",
      "description": "Verse Vault is a personal Bible memory application that allows users to save, organize, and recall their favorite King James Version Bible verses. It offers both local and server storage options for personalized verse management.",
      "url": "https://verse-vault.github.io/verse-vault/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://verse-vault.github.io/verse-vault/?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      },
      "applicationCategory": "ReferenceApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "softwareRequirements": "Web browser, internet connection (for API/server storage)",
      "operatingSystem": "Any"
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": "Your Saved Bible Verses",
      "description": "A collection of user-saved Bible verses within the Verse Vault application.",
      "about": {
        "@type": "Thing",
        "name": "Bible Verses"
      }
    }
    </script>

    <meta charset="UTF-8">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Basic Reset & Font */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* App Container */
        #app-container {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 32px;
            width: 100%;
            max-width: 960px;
            border: 1px solid #e5e7eb;
            box-sizing: border-box;
            margin: 20px; /* Add margin for smaller screens */
        }

        /* Header */
        h1 {
            font-size: 36px;
            font-weight: 800;
            text-align: center;
            color: #1e40af;
            margin-bottom: 32px;
            letter-spacing: -0.025em;
        }
        h1 i {
            color: #2563eb;
            margin-right: 12px;
        }

        /* Section Headers */
        h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
        }
        h3 {
            font-size: 24px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        h3 i {
            margin-right: 12px;
        }

        /* Buttons */
        button {
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        button i {
            margin-right: 8px;
        }

        #add-verse-btn {
            background-color: #2563eb;
            color: #ffffff;
        }
        #add-verse-btn:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        #back-to-main-btn {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        #back-to-main-btn:hover {
            background-color: #d1d5db;
            transform: translateX(-2px);
        }

        #fetch-verse-btn {
            background-color: #10b981;
            color: #ffffff;
        }
        #fetch-verse-btn:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }

        #save-fetched-verse-btn {
            background-color: #2563eb;
            color: #ffffff;
            width: 100%;
        }
        #save-fetched-verse-btn:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        #save-custom-verse-btn {
            background-color: #f59e0b;
            color: #ffffff;
            width: 100%;
        }
        #save-custom-verse-btn:hover {
            background-color: #d97706;
            transform: translateY(-2px);
        }

        .delete-verse-btn {
            background: none;
            box-shadow: none;
            color: #ef4444;
            padding: 0;
            margin: 0;
            transition: color 0.2s ease-in-out;
        }
        .delete-verse-btn:hover {
            color: #dc2626;
            transform: none; /* Override translateY for delete button */
        }

        /* Form Elements */
        label {
            display: block;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.15s ease-in-out;
            box-sizing: border-box; /* Ensure padding doesn't increase width */
        }
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        textarea {
            resize: vertical;
        }

        /* Checkbox */
        input[type="checkbox"] {
            height: 20px;
            width: 20px;
            color: #2563eb;
            border-color: #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            vertical-align: middle;
        }
        input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Layout Helpers */
        .hidden {
            display: none !important;
        }
        .space-y-6 > *:not(:last-child) {
            margin-bottom: 24px;
        }
        .space-y-8 > *:not(:last-child) {
            margin-bottom: 32px;
        }
        .flex {
            display: flex;
        }
        .justify-between {
            justify-content: space-between;
        }
        .items-center {
            align-items: center;
        }
        .items-end {
            align-items: flex-end;
        }
        .items-start {
            align-items: flex-start;
        }
        .flex-col {
            flex-direction: column;
        }
        .flex-grow {
            flex-grow: 1;
        }
        .grid {
            display: grid;
        }
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .gap-4 {
            gap: 16px;
        }
        .gap-6 {
            gap: 24px;
        }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-4 { margin-top: 16px; }
        .mt-6 { margin-top: 24px; }
        .ml-2 { margin-left: 8px; }
        .ml-4 { margin-left: 16px; }
        .mr-2 { margin-right: 8px; }
        .mr-3 { margin-right: 12px; }
        .pr-2 { padding-right: 8px; }
        .pt-2 { padding-top: 8px; }

        /* Card Styles */
        .verse-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 24px;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            position: relative; /* For delete button positioning */
        }
        .verse-card p {
            margin: 0;
        }
        .verse-card .reference {
            font-size: 20px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 12px;
        }
        .verse-card .text {
            color: #1f2937;
            line-height: 1.625;
            font-size: 16px;
            flex-grow: 1;
            margin-bottom: 16px;
        }
        .verse-card .meta {
            font-size: 12px;
            color: #6b7280;
            text-align: right;
        }

        /* Section Styling */
        .api-section, .custom-section {
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid;
        }
        .api-section {
            background-color: #eff6ff; /* blue-50 */
            border-color: #bfdbfe; /* blue-200 */
        }
        .custom-section {
            background-color: #fffbeb; /* yellow-50 */
            border-color: #fef3c7; /* yellow-200 */
        }

        /* Fetched Verse Display */
        #fetched-verse-display {
            margin-top: 24px;
            padding: 16px;
            background-color: #ffffff;
            border: 1px dashed #93c5fd; /* blue-300 */
            border-radius: 8px;
        }
        #fetched-verse-display p {
            margin: 0;
        }
        #fetched-verse-ref {
            color: #4b5563; /* gray-700 */
            margin-bottom: 8px;
            font-weight: 500;
        }
        #fetched-verse-text {
            color: #111827; /* gray-900 */
            line-height: 1.625;
            font-size: 18px;
        }

        /* No Verses Message */
        #no-verses-message {
            color: #6b7280;
            text-align: center;
            grid-column: 1 / -1; /* Span full width */
        }

        /* Custom Scrollbar */
        #verses-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Message Box */
        #message-box, #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #message-box > div {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 384px;
            width: 100%;
            text-align: center;
        }
        #message-box-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
        }
        #message-box-body {
            color: #374151;
            margin-bottom: 24px;
        }
        #message-box-ok-btn {
            background-color: #2563eb;
            color: #ffffff;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        #message-box-ok-btn:hover {
            background-color: #1d4ed8;
        }

        /* Loading Spinner */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #loading-overlay > div {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            height: 64px;
            width: 64px;
        }
        #loading-overlay p {
            color: #ffffff;
            margin-left: 16px;
            font-size: 18px;
        }


        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .md\:flex-row {
                flex-direction: row;
            }
            .md\:mb-0 {
                margin-bottom: 0;
            }
            /* Removed md:grid-cols-2 for verses-list */
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .md\:p-8 {
                padding: 32px;
            }
            .md\:pt-0 {
                padding-top: 0;
            }
        }
        /* Auth specific styles */
        #auth-section {
            margin-bottom: 24px;
            padding: 24px;
            background-color: #e0f2fe; /* Light blue background for auth section */
            border-radius: 12px;
            border: 1px solid #90cdf4;
        }
        #auth-section input {
            margin-bottom: 12px;
        }
        #auth-section button {
            width: 100%;
            margin-top: 12px;
            background-color: #2563eb;
            color: white;
        }
        #auth-section button:hover {
            background-color: #1d4ed8;
        }
        #auth-section .toggle-link {
            text-align: center;
            margin-top: 16px;
            color: #3b82f6;
            cursor: pointer;
            font-weight: 500;
        }
        #auth-section .toggle-link:hover {
            text-decoration: underline;
        }
        #auth-status {
            text-align: center;
            margin-bottom: 16px;
            color: #10b981;
            font-weight: 600;
        }
        #logout-btn {
            background-color: #ef4444;
            color: white;
            margin-left: 10px;
        }
        #logout-btn:hover {
            background-color: #dc2626;
        }
        .user-info {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            color: #1f2937;
            font-size: 1.1em;
            font-weight: 500;
        }
        .user-info i {
            margin-right: 8px;
            color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="app-container">
        <!-- Loading Indicator -->
        <div id="loading-overlay" class="hidden">
            <div></div>
            <p>Loading...</p>
        </div>

        <!-- Header -->
        <h1>
            <i class="fas fa-book-bible"></i>Verse Vault
        </h1>

        <!-- Authentication Section -->
        <div id="auth-section">
            <div id="login-form">
                <h2 style="text-align: center;">Login</h2>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button id="login-btn"><i class="fas fa-sign-in-alt"></i>Login</button>
                <p class="toggle-link" id="show-signup">Don't have an account? Sign Up</p>
            </div>
            <div id="signup-form" class="hidden">
                <h2 style="text-align: center;">Sign Up</h2>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button id="signup-btn"><i class="fas fa-user-plus"></i>Sign Up</button>
                <p class="toggle-link" id="show-login">Already have an account? Login</p>
            </div>
            <div id="auth-status" class="hidden">
                <p class="user-info"><i class="fas fa-user-circle"></i>Logged in as: <span id="user-email"></span></p>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i>Logout</button>
            </div>
        </div>

        <!-- Main View: Saved Verses (Hidden until authenticated) -->
        <div id="main-view" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2>Your Saved Verses</h2>
                <button id="add-verse-btn">
                    <i class="fas fa-plus-circle"></i>Add New Verse
                </button>
            </div>

            <div id="verses-list" class="grid grid-cols-1 gap-6">
                <p id="no-verses-message">No verses saved yet. Add your first verse!</p>
            </div>
        </div>

        <!-- Add Verse View (Hidden until authenticated) -->
        <div id="add-verse-view" class="hidden">
            <button id="back-to-main-btn" class="mb-6">
                <i class="fas fa-arrow-left"></i>Back to Saved Verses
            </button>

            <h2 style="text-align: center; margin-bottom: 24px;">Add a New Verse</h2>

            <!-- Add from KJV.txt File Section -->
            <div class="api-section mb-8">
                <h3><i class="fas fa-book-reader"></i>Fetch from KJV.txt</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
                    <div>
                        <label for="book-select">Book:</label>
                        <select id="book-select"></select>
                    </div>
                    <div>
                        <label for="chapter-select">Chapter:</label>
                        <select id="chapter-select">
                            <option value="">Select Chapter</option>
                        </select>
                    </div>
                    <div class="flex items-end pt-2 md:pt-0">
                        <div class="flex-grow">
                            <label for="verse-input">Verse (Optional):</label>
                            <input type="number" id="verse-input" placeholder="e.g., 16">
                        </div>
                        <div class="ml-4 flex items-center">
                            <input type="checkbox" id="whole-chapter-checkbox">
                            <label for="whole-chapter-checkbox" style="margin-bottom: 0;">Whole Chapter</label>
                        </div>
                    </div>
                </div>
                <button id="fetch-verse-btn">
                    <i class="fas fa-search"></i>Fetch Verse
                </button>

                <!-- Fetched Verse Display -->
                <div id="fetched-verse-display" class="hidden">
                    <p id="fetched-verse-ref"></p>
                    <p id="fetched-verse-text"></p>
                    <button id="save-fetched-verse-btn" class="mt-4">
                        <i class="fas fa-save"></i>Save Fetched Verse
                    </button>
                </div>
            </div>

            <!-- Custom Verse Input Section -->
            <div class="custom-section">
                <h3><i class="fas fa-pencil-alt"></i>Input Custom Verse</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
                    <div>
                        <label for="custom-book-input">Book:</label>
                        <input type="text" id="custom-book-input" placeholder="e.g., John">
                    </div>
                    <div>
                        <label for="custom-chapter-input">Chapter:</label>
                        <input type="number" id="custom-chapter-input" placeholder="e.g., 3">
                    </div>
                    <div>
                        <label for="custom-verse-numbers-input">Verse(s):</label>
                        <input type="text" id="custom-verse-numbers-input" placeholder="e.g., 16 or 1-5">
                    </div>
                </div>
                <div class="mb-5">
                    <label for="custom-verse-text-area">Verse Text:</label>
                    <textarea id="custom-verse-text-area" rows="6" placeholder="Type your custom verse text here..."></textarea>
                </div>
                <button id="save-custom-verse-btn">
                    <i class="fas fa-bookmark"></i>Save Custom Verse
                </button>
            </div>
        </div>

        <!-- Custom Message Box -->
        <div id="message-box" class="hidden">
            <div>
                <h3 id="message-box-title"></h3>
                <p id="message-box-body"></p>
                <button id="message-box-ok-btn">OK</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Corrected import: added 'doc' to the Firestore imports
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Configuration and App ID
        const appId = 'verse-vault-external'; // Hardcoded Project ID
        const firebaseConfig = {
            apiKey: 'AIzaSyB6W6TUe7j6nPDXNt557lHsviA2HviSD4M', // Hardcoded Web API Key
            authDomain: 'verse-vault-external.firebaseapp.com',
            projectId: 'verse-vault-external',
            storageBucket: 'verse-vault-external.appspot.com',
            messagingSenderId: '1026923647152', // Project number
            appId: '1:1026923647152:web:a6167822a106e2365eb26d' // Your Firebase App ID from project settings
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null; // To store the current authenticated user object
        let firestoreUnsubscribe = null; // To store the Firestore unsubscribe function

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authStatus = document.getElementById('auth-status');
        const userEmailSpan = document.getElementById('user-email');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showSignupLink = document.getElementById('show-signup');
        const showLoginLink = document.getElementById('show-login');

        const mainView = document.getElementById('main-view');
        const addVerseView = document.getElementById('add-verse-view');
        const addVerseBtn = document.getElementById('add-verse-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const versesList = document.getElementById('verses-list');
        const noVersesMessage = document.getElementById('no-verses-message');

        // KJV.txt Fetch Elements
        const bookSelect = document.getElementById('book-select');
        const chapterSelect = document.getElementById('chapter-select');
        const verseInput = document.getElementById('verse-input');
        const wholeChapterCheckbox = document.getElementById('whole-chapter-checkbox');
        const fetchVerseBtn = document.getElementById('fetch-verse-btn');
        const fetchedVerseDisplay = document.getElementById('fetched-verse-display');
        const fetchedVerseRef = document.getElementById('fetched-verse-ref');
        const fetchedVerseText = document.getElementById('fetched-verse-text');
        const saveFetchedVerseBtn = document.getElementById('save-fetched-verse-btn');

        // Custom Verse Elements
        const customBookInput = document.getElementById('custom-book-input');
        const customChapterInput = document.getElementById('custom-chapter-input');
        const customVerseNumbersInput = document.getElementById('custom-verse-numbers-input');
        const customVerseTextArea = document.getElementById('custom-verse-text-area');
        const saveCustomVerseBtn = document.getElementById('save-custom-verse-btn');

        // Message Box Elements
        const messageBox = document.getElementById('message-box');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxBody = document.getElementById('message-box-body');
        const messageBoxOkBtn = document.getElementById('message-box-ok-btn');

        // Global variable to store parsed Bible data from kjv.txt
        let parsedBibleData = {};
        let bookAbbreviations = [];

        // Canonical order of Bible books (King James Version abbreviations)
        const bibleBookOrder = [
            "GEN", "EXO", "LEV", "NUM", "DEU", "JOS", "JDG", "RUT", "1SA", "2SA",
            "1KI", "2KI", "1CH", "2CH", "EZR", "NEH", "EST", "JOB", "PSA", "PRO",
            "ECC", "SNG", "ISA", "JER", "LAM", "EZE", "DAN", "HOS", "JOL", "AMO",
            "OBA", "JON", "MIC", "NAM", "HAB", "ZEP", "HAG", "ZEC", "MAL", "MAT",
            "MAR", "LUK", "JOH", "ACT", "ROM", "1CO", "2CO", "GAL", "EPH", "PHP",
            "COL", "1TH", "2TH", "1TI", "2TI", "TIT", "PHM", "HEB", "JAM", "1PE",
            "2PE", "1JO", "2JO", "3JO", "JUD", "REV"
        ];

        // --- Utility Functions ---

        const showLoading = () => loadingOverlay.classList.remove('hidden');
        const hideLoading = () => loadingOverlay.classList.add('hidden');

        const showMessageBox = (title, message, onConfirm = null) => {
            messageBoxTitle.textContent = title;
            messageBoxBody.textContent = message;
            messageBoxOkBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (onConfirm) onConfirm(true);
            };
            messageBox.classList.remove('hidden');
        };

        // --- Authentication Functions ---

        showSignupLink.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            loginEmailInput.value = '';
            loginPasswordInput.value = '';
        });

        showLoginLink.addEventListener('click', () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            signupEmailInput.value = '';
            signupPasswordInput.value = '';
        });

        signupBtn.addEventListener('click', async () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            if (!email || !password) {
                showMessageBox('Input Error', 'Please enter both email and password.');
                return;
            }
            showLoading();
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessageBox('Success', 'Account created successfully! You are now logged in.');
                signupEmailInput.value = '';
                signupPasswordInput.value = '';
            } catch (error) {
                console.error('Sign Up Error:', error);
                showMessageBox('Sign Up Failed', `Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showMessageBox('Input Error', 'Please enter both email and password.');
                return;
            }
            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessageBox('Success', 'Logged in successfully!');
                loginEmailInput.value = '';
                loginPasswordInput.value = '';
            } catch (error) {
                console.error('Login Error:', error);
                showMessageBox('Login Failed', `Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            showLoading();
            try {
                await signOut(auth);
                showMessageBox('Logged Out', 'You have been logged out.');
            } catch (error) {
                console.error('Logout Error:', error);
                showMessageBox('Logout Failed', `Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // --- Firebase Authentication State Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authSection.classList.add('hidden');
                mainView.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                authStatus.classList.remove('hidden');
                // Setup Firestore listener when user logs in
                setupFirestoreListener(user.uid);
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                mainView.classList.add('hidden');
                addVerseView.classList.add('hidden');
                authStatus.classList.add('hidden');
                // Unsubscribe from Firestore updates when user logs out
                if (firestoreUnsubscribe) {
                    firestoreUnsubscribe();
                    firestoreUnsubscribe = null;
                }
                versesList.innerHTML = ''; // Clear verses on logout
                noVersesMessage.classList.remove('hidden');
            }
        });

        // --- Firestore Operations ---

        const setupFirestoreListener = (userId) => {
            if (firestoreUnsubscribe) {
                firestoreUnsubscribe(); // Unsubscribe from previous listener if any
            }
            const versesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/verses`);
            firestoreUnsubscribe = onSnapshot(query(versesCollectionRef), (snapshot) => {
                versesList.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    noVersesMessage.classList.remove('hidden');
                } else {
                    noVersesMessage.classList.add('hidden');
                    const verses = [];
                    snapshot.forEach(doc => {
                        const verseData = doc.data();
                        verses.push({ id: doc.id, ...verseData }); // Store Firestore document ID
                    });
                    // Sort verses by timestamp in descending order
                    verses.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    verses.forEach((verse) => {
                        const verseCard = document.createElement('div');
                        verseCard.className = 'verse-card';
                        verseCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <p class="reference">${verse.reference}</p>
                                <button data-id="${verse.id}" class="delete-verse-btn" title="Delete Verse">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <p class="text">${verse.text}</p>
                            <p class="meta">Source: ${verse.source} | Saved: ${verse.timestamp ? new Date(verse.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                        `;
                        versesList.appendChild(verseCard);
                    });

                    document.querySelectorAll('.delete-verse-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const idToDelete = event.currentTarget.dataset.id;
                            showMessageBox('Confirm Delete', 'Are you sure you want to delete this verse?', (confirmed) => {
                                if (confirmed) {
                                    deleteVerse(idToDelete);
                                }
                            });
                        });
                    });
                }
            }, (error) => {
                console.error("Error fetching verses from Firestore:", error);
                showMessageBox('Data Error', `Failed to load verses: ${error.message}`);
            });
        };

        const deleteVerse = async (idToDelete) => {
            if (!currentUser) {
                showMessageBox('Error', 'You must be logged in to delete verses.');
                return;
            }
            showLoading();
            try {
                // Corrected usage: doc(db, path, id)
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/verses`, idToDelete));
                showMessageBox('Deleted', 'Verse deleted successfully.');
            } catch (error) {
                console.error('Error deleting verse:', error);
                showMessageBox('Delete Error', `Failed to delete verse: ${error.message}`);
            } finally {
                hideLoading();
            }
        };

        // --- Navigation ---
        addVerseBtn.addEventListener('click', () => {
            if (!currentUser) {
                showMessageBox('Login Required', 'Please log in to add verses.');
                return;
            }
            mainView.classList.add('hidden');
            addVerseView.classList.remove('hidden');
            fetchedVerseDisplay.classList.add('hidden');
            fetchedVerseRef.textContent = '';
            fetchedVerseText.textContent = '';
        });

        backToMainBtn.addEventListener('click', () => {
            addVerseView.classList.add('hidden');
            mainView.classList.remove('hidden');
        });

        // --- KJV.txt Loading and Parsing ---

        const loadKjvText = async () => {
            showLoading();
            try {
                const response = await fetch('kjv.txt'); // Assuming kjv.txt is in the same directory
                if (!response.ok) {
                    throw new Error(`Failed to load kjv.txt: ${response.statusText} (Status: ${response.status})`);
                }
                const text = await response.text();

                const lines = text.split('\n');
                const tempBibleData = {};
                const encounteredBookAbbreviations = new Set();

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    const parts = line.match(/^([A-Z0-9]+)\s(\d+):(\d+)\s(.*)/);
                    if (parts) {
                        const bookAbbr = parts[1];
                        const chapterNum = parseInt(parts[2]);
                        const verseNum = parseInt(parts[3]);
                        const verseText = parts[4].trim();

                        if (!tempBibleData[bookAbbr]) {
                            tempBibleData[bookAbbr] = {};
                        }
                        if (!tempBibleData[bookAbbr][chapterNum]) {
                            tempBibleData[bookAbbr][chapterNum] = {};
                        }
                        tempBibleData[bookAbbr][chapterNum][verseNum] = verseText;
                        encounteredBookAbbreviations.add(bookAbbr);
                    } else {
                        console.warn(`Skipping malformed line: ${line}`);
                    }
                });

                parsedBibleData = tempBibleData;
                bookAbbreviations = bibleBookOrder.filter(abbr => encounteredBookAbbreviations.has(abbr));

                console.log('KJV.txt loaded and parsed successfully.');
                populateBooks();
            } catch (error) {
                console.error('Error loading or parsing KJV.txt:', error);
                showMessageBox('Data Load Error', `Failed to load Bible data: ${error.message}. Please ensure 'kjv.txt' is available and correctly formatted.`);
            } finally {
                hideLoading();
            }
        };

        const populateBooks = () => {
            bookSelect.innerHTML = '<option value="">Select Book</option>';
            bookAbbreviations.forEach(abbr => {
                const option = document.createElement('option');
                option.value = abbr;
                option.textContent = abbr;
                bookSelect.appendChild(option);
            });
        };

        const populateChapters = () => {
            chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            const selectedBookAbbr = bookSelect.value;
            const bookChapters = parsedBibleData[selectedBookAbbr];

            if (bookChapters) {
                const chapters = Object.keys(bookChapters).map(Number).sort((a, b) => a - b);
                chapters.forEach(chapterNum => {
                    const option = document.createElement('option');
                    option.value = chapterNum;
                    option.textContent = chapterNum;
                    chapterSelect.appendChild(option);
                });
            }
        };

        bookSelect.addEventListener('change', populateChapters);

        wholeChapterCheckbox.addEventListener('change', () => {
            verseInput.disabled = wholeChapterCheckbox.checked;
            verseInput.value = '';
        });

        // --- Fetch Verse from KJV.txt Data ---
        fetchVerseBtn.addEventListener('click', () => {
            const bookAbbr = bookSelect.value;
            const chapterNum = parseInt(chapterSelect.value);
            const verseNum = parseInt(verseInput.value);
            const isWholeChapter = wholeChapterCheckbox.checked;

            if (!bookAbbr || isNaN(chapterNum)) {
                showMessageBox('Missing Information', 'Please select a Book and a Chapter.');
                return;
            }

            let verseText = '';
            let reference = `${bookAbbr} ${chapterNum}`;

            const bookData = parsedBibleData[bookAbbr];
            if (!bookData || !bookData[chapterNum]) {
                showMessageBox('Verse Not Found', 'Could not find the specified book or chapter.');
                fetchedVerseDisplay.classList.add('hidden');
                return;
            }

            if (isWholeChapter) {
                const chapterVerses = bookData[chapterNum];
                const sortedVerseNumbers = Object.keys(chapterVerses).map(Number).sort((a, b) => a - b);
                if (sortedVerseNumbers.length === 0) {
                     showMessageBox('Verse Not Found', 'No verses found for the selected chapter.');
                     fetchedVerseDisplay.classList.add('hidden');
                     return;
                }
                verseText = sortedVerseNumbers.map(vNum => `${vNum}. ${chapterVerses[vNum]}`).join(' ');
            } else if (!isNaN(verseNum)) {
                verseText = bookData[chapterNum][verseNum];
                reference += `:${verseNum}`;
            } else {
                showMessageBox('Missing Information', 'Please enter a Verse number or check "Whole Chapter".');
                fetchedVerseDisplay.classList.add('hidden');
                return;
            }

            if (verseText) {
                fetchedVerseRef.textContent = reference;
                fetchedVerseText.textContent = verseText.trim();
                fetchedVerseDisplay.classList.remove('hidden');
            } else {
                showMessageBox('Verse Not Found', 'Could not find the specified verse(s) in the loaded KJV text.');
                fetchedVerseDisplay.classList.add('hidden');
            }
        });

        // --- Save Fetched Verse to Firestore ---
        saveFetchedVerseBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showMessageBox('Login Required', 'Please log in to save verses.');
                return;
            }
            if (!fetchedVerseRef.textContent || !fetchedVerseText.textContent) {
                showMessageBox('No Verse to Save', 'Please fetch a verse first.');
                return;
            }

            const book = bookSelect.value;
            const chapter = chapterSelect.value;
            const verseNumbers = wholeChapterCheckbox.checked ? 'Whole Chapter' : verseInput.value;
            const text = fetchedVerseText.textContent;
            const reference = fetchedVerseRef.textContent;

            showLoading();
            try {
                const versesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/verses`);
                await addDoc(versesCollectionRef, {
                    book: book,
                    chapter: chapter,
                    verseNumbers: verseNumbers,
                    text: text,
                    reference: reference,
                    source: `KJV.txt (Local)`,
                    timestamp: serverTimestamp() // Firebase server timestamp
                });
                showMessageBox('Success', 'Verse saved successfully!');
                fetchedVerseDisplay.classList.add('hidden');
                fetchedVerseRef.textContent = '';
                fetchedVerseText.textContent = '';
                addVerseView.classList.add('hidden');
                mainView.classList.remove('hidden');
            } catch (error) {
                console.error('Error saving fetched verse:', error);
                showMessageBox('Save Error', `Failed to save verse: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // --- Save Custom Verse to Firestore ---
        saveCustomVerseBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showMessageBox('Login Required', 'Please log in to save verses.');
                return;
            }
            const book = customBookInput.value.trim();
            const chapter = customChapterInput.value.trim();
            const verseNumbers = customVerseNumbersInput.value.trim();
            const text = customVerseTextArea.value.trim();

            if (!book || !chapter || !text) {
                showMessageBox('Missing Information', 'Please fill in all required fields for your custom verse (Book, Chapter, Text).');
                return;
            }

            showLoading();
            try {
                const versesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/verses`);
                await addDoc(versesCollectionRef, {
                    book: book,
                    chapter: chapter,
                    verseNumbers: verseNumbers || 'Custom',
                    text: text,
                    reference: `${book} ${chapter}${verseNumbers ? ':' + verseNumbers : ''}`,
                    source: 'Custom',
                    timestamp: serverTimestamp() // Firebase server timestamp
                });
                showMessageBox('Success', 'Custom verse saved successfully!');
                customBookInput.value = '';
                customChapterInput.value = '';
                customVerseNumbersInput.value = '';
                customVerseTextArea.value = '';
                addVerseView.classList.add('hidden');
                mainView.classList.remove('hidden');
            } catch (error) {
                console.error('Error saving custom verse:', error);
                showMessageBox('Save Error', `Failed to save custom verse: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // --- Initial Load ---
        window.onload = () => {
            loadKjvText(); // Load the KJV text file and populate books
            // onAuthStateChanged will handle displaying the correct view
        };
    </script>
</body>
</html>
